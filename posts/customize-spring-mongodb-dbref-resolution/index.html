<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="prefer-datetime-locale" content="en"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="⚙️ Customize Spring MongoDB DBRef Resolution" /><meta property="og:locale" content="en" /><meta name="description" content="I think I will not open a secret saying that many developers love Spring for the ability to quickly make sometimes complex things relatively simple and elegant. A huge community of developers with their questions and answers helps to quickly find a solution to a particular problem." /><meta property="og:description" content="I think I will not open a secret saying that many developers love Spring for the ability to quickly make sometimes complex things relatively simple and elegant. A huge community of developers with their questions and answers helps to quickly find a solution to a particular problem." /><link rel="canonical" href="https://www.fisenko.net/posts/customize-spring-mongodb-dbref-resolution/" /><meta property="og:url" content="https://www.fisenko.net/posts/customize-spring-mongodb-dbref-resolution/" /><meta property="og:site_name" content="Dmitry Fisenko" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-02-12T02:00:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="⚙️ Customize Spring MongoDB DBRef Resolution" /><meta name="twitter:site" content="@fisenkodv" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-02-12T02:00:00-05:00","datePublished":"2021-02-12T02:00:00-05:00","description":"I think I will not open a secret saying that many developers love Spring for the ability to quickly make sometimes complex things relatively simple and elegant. A huge community of developers with their questions and answers helps to quickly find a solution to a particular problem.","headline":"⚙️ Customize Spring MongoDB DBRef Resolution","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.fisenko.net/posts/customize-spring-mongodb-dbref-resolution/"},"url":"https://www.fisenko.net/posts/customize-spring-mongodb-dbref-resolution/"}</script><title>⚙️ Customize Spring MongoDB DBRef Resolution | Dmitry Fisenko</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Dmitry Fisenko"><meta name="application-name" content="Dmitry Fisenko"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://raw.githubusercontent.com/fisenkodv/home-page/main/assets/img/profile-photos/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Dmitry Fisenko</a></div><div class="site-subtitle font-italic">Software Engineer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/fisenkodv" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/fisenkodv" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['dmitry','fisenko.net'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>⚙️ Customize Spring MongoDB DBRef Resolution</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>⚙️ Customize Spring MongoDB DBRef Resolution</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1613113200" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Feb 12, 2021 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/fisenkodv">Dmitry Fisenko</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="796 words"> <em>4 min</em> read</span></div></div></div><div class="post-content"><p>I think I will not open a secret saying that many developers love <a href="https://spring.io/">Spring</a> for the ability to quickly make sometimes complex things relatively simple and elegant. A huge community of developers with their questions and answers helps to quickly find a solution to a particular problem.</p><p>Today I would like to share one solution that allowed me to significantly improve performance when reading data from MongoDB.</p><p>In my scenario, I’m actively using <a href="https://docs.mongodb.com/manual/reference/database-references/">DBRefs</a> to refer from one object to another instead of embedding objects within a document. Perhaps you can argue and say that it should not be used taking into account that on the MongoDB web site there is</p><blockquote><p>Unless you have a compelling reason to use DBRefs, use manual references instead.</p></blockquote><p>But my point is if MongoDB has such type, where I can explicitly see the information about collection and ID why don’t use it. Another point is my data layer is build on top of <a href="https://spring.io/projects/spring-data-mongodb">Spring Data MongoDB</a> which simplifies many things one thing is how Spring Data MongoDB mapping framework works with DBRefs</p><blockquote><p>The mapping framework does not have to store child objects embedded within the document. You can also store them separately and use a DBRef to refer to that document. When the object is loaded from MongoDB, those references are eagerly resolved so that you get back a mapped object that looks the same as if it had been stored embedded within your top-level document.<br /> _ <strong>Source</strong> _: <a href="https://docs.spring.io/spring-data/mongodb/docs/3.1.3/reference/html/#mapping-usage-references">https://docs.spring.io/spring-data/mongodb/docs/3.1.3/reference/html/#mapping-usage-references</a></p></blockquote><p>And everything is good until you have relatively small objects without deep nesting. When nesting becomes quite deep or when you need to load more data or when DB grows you might notice performance degradation like happened in my scenario, i.e. each time when the mapping framework fetches the data, even if data is repeated it tries to fetch each time ignoring the fact the same portion already fetched from the DB.</p><p>To resolve DBRefs by default Spring uses <a href="https://docs.spring.io/spring-data/data-mongodb/docs/current/api/org/springframework/data/mongodb/core/convert/DefaultDbRefResolver.html">DefaultDbRefResolver</a>. Enabling logging for <code class="language-plaintext highlighter-rouge">org.springframework.data.mongodb.core.convert.DefaultDbRefResolver</code> might be very useful to see what happens.</p><p>In my application, I noticed too much <code class="language-plaintext highlighter-rouge">Fetching DBRef...</code> and <code class="language-plaintext highlighter-rouge">Bulk fetching DBRefs...</code> which pushed me to move in that direction and come up with a solution to avoid unnecessarily fetching. I decided to create a custom <code class="language-plaintext highlighter-rouge">DbRefResolver</code> and use <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-caching">Spring caching</a>. Below is my <code class="language-plaintext highlighter-rouge">CachedDbRefReolver</code></p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CachedDbRefResolver</span> <span class="kd">extends</span> <span class="nc">DefaultDbRefResolver</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Cache</span> <span class="n">cache</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">CachedDbRefResolver</span><span class="o">(</span><span class="nc">MongoDatabaseFactory</span> <span class="n">mongoDbFactory</span><span class="o">,</span> <span class="nc">CacheManager</span> <span class="n">cacheManager</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">mongoDbFactory</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">cache</span> <span class="o">=</span> <span class="n">cacheManager</span><span class="o">.</span><span class="na">getCache</span><span class="o">(</span><span class="nc">CacheConstants</span><span class="o">.</span><span class="na">DBREF_CACHE_NAME</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Document</span> <span class="nf">fetch</span><span class="o">(</span><span class="nd">@NotNull</span> <span class="nc">DBRef</span> <span class="n">dbRef</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Document</span> <span class="n">document</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">dbRef</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span> <span class="nc">Document</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">document</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">document</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">fetch</span><span class="o">(</span><span class="n">dbRef</span><span class="o">);</span>
            <span class="n">cache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">dbRef</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span> <span class="n">document</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">document</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nd">@NotNull</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Document</span><span class="o">&gt;</span> <span class="nf">bulkFetch</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">DBRef</span><span class="o">&gt;</span> <span class="n">dbRefs</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">DBRef</span><span class="o">&gt;</span> <span class="n">missingDbRefs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Document</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">DBRef</span> <span class="n">dbRef</span> <span class="o">:</span> <span class="n">dbRefs</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Document</span> <span class="n">document</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">dbRef</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span> <span class="nc">Document</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">document</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">missingDbRefs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">dbRef</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">document</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">missingDbRefs</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Document</span><span class="o">&gt;</span> <span class="n">missingDocuments</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">bulkFetch</span><span class="o">(</span><span class="n">missingDbRefs</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Document</span> <span class="n">missingDocument</span> <span class="o">:</span> <span class="n">missingDocuments</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">cache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">missingDocument</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="nc">MongoUtils</span><span class="o">.</span><span class="na">UNDERSCORE_ID</span><span class="o">).</span><span class="na">toString</span><span class="o">(),</span> <span class="n">missingDocument</span><span class="o">);</span>
                <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">missingDocument</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>As you can see I use <code class="language-plaintext highlighter-rouge">DefaultDbRefResolver</code> as the base and override two methods:</p><ul><li><code class="language-plaintext highlighter-rouge">fetch</code> to fetch individual Documents<li><code class="language-plaintext highlighter-rouge">bulkFetch</code> for bulk fetching to fetch only items, not existing in the cache</ul><p>In the code above I use a few constants:</p><ul><li><code class="language-plaintext highlighter-rouge">CacheConstants.DBREF_CACHE_NAME</code> is <code class="language-plaintext highlighter-rouge">public static final String DBREF_CACHE_NAME = "DBREF";</code><li><code class="language-plaintext highlighter-rouge">MongoUtils.UNDERSCORE_ID</code> is <code class="language-plaintext highlighter-rouge">public static final String UNDERSCORE_ID = "_id";</code></ul><p>My <code class="language-plaintext highlighter-rouge">CacheManager</code> is <code class="language-plaintext highlighter-rouge">ConcurrentMapCacheManager</code> registered as</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CacheBeans</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">CacheManager</span> <span class="nf">cacheManager</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ConcurrentMapCacheManager</span><span class="o">(</span><span class="nc">CacheConstants</span><span class="o">.</span><span class="na">DBREF_CACHE_NAME</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>See more details here <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-caching-provider">Supported Cache Providers</a>.</p><p>Another important point with cache is a cache eviction.</p><blockquote><p><em>There are only two hard things in Computer Science: cache invalidation and naming things.</em><br /> <em>– Phil Karlton</em></p></blockquote><p>Since I know when the data could be evicted from the cache. In my scenario, I have a custom repository to get access to the data and any update means that an item needs to be evicted. Considering all of the above I see two options:</p><ul><li>remove the documents by ID from the cache directly<li>use <code class="language-plaintext highlighter-rouge">@CacheEvict</code> annotation, see docs <a href="https://docs.spring.io/spring-framework/docs/current/reference/html/integration.html#cache-annotations-evict">here</a></ul><p>For simplicity sake, I decided to use the second option because at the moment this is more than enough for me, below is how it looks like</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MongoUserRepository</span> <span class="kd">implements</span> <span class="nc">UserRepository</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="nd">@CacheEvict</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="nc">CacheConstants</span><span class="o">.</span><span class="na">DBREF_CACHE_NAME</span><span class="o">,</span> <span class="n">key</span> <span class="o">=</span> <span class="s">"#user.id"</span><span class="o">,</span> <span class="n">beforeInvocation</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">update</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// update user in the DB</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Hopefully, this information will be useful!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/java/'>Java</a>, <a href='/categories/spring/'>Spring</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/java/" class="post-tag no-text-decoration" >java</a> <a href="/tags/spring/" class="post-tag no-text-decoration" >spring</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=%E2%9A%99%EF%B8%8F+Customize+Spring+MongoDB+DBRef+Resolution+-+Dmitry+Fisenko&url=https%3A%2F%2Fwww.fisenko.net%2Fposts%2Fcustomize-spring-mongodb-dbref-resolution%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=%E2%9A%99%EF%B8%8F+Customize+Spring+MongoDB+DBRef+Resolution+-+Dmitry+Fisenko&u=https%3A%2F%2Fwww.fisenko.net%2Fposts%2Fcustomize-spring-mongodb-dbref-resolution%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fwww.fisenko.net%2Fposts%2Fcustomize-spring-mongodb-dbref-resolution%2F&text=%E2%9A%99%EF%B8%8F+Customize+Spring+MongoDB+DBRef+Resolution+-+Dmitry+Fisenko" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/deploying-ghost-in-docker/">🚀 Deploying Ghost to Synology NAS</a><li><a href="/posts/adding-ram-to-synology-ds-218/">🔌 Adding RAM to Synology DS 218+</a><li><a href="/posts/docker-container-update-automation-on-synology-nas/">🏗️ Docker container update automation on Synology NAS</a><li><a href="/posts/convert-event-based-listeners-to-flux/">⛓ Convert event-based API to Flux</a><li><a href="/posts/synology-configuring-domain-part-2/">🕸 Configuring Synology NAS to use its own domain name. Part 2</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/synology/">synology</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/arduino/">arduino</a> <a class="post-tag" href="/tags/flux/">flux</a> <a class="post-tag" href="/tags/iot/">iot</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/mariadb/">mariadb</a> <a class="post-tag" href="/tags/ubiquity/">ubiquity</a></div></div></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/measure-method-execution-time-using-spring-aop/"><div class="card-body"> <em class="small" data-ts="1588690800" data-df="ll" > May 5, 2020 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>📏 Measure method execution time using Spring AOP</h3><div class="text-muted small"><p> There are times when it is necessary to be able to log the execution time of a method. The simplest way to achieve that would be to modify every method by adding Stopwatch or System.currentTimeMill...</p></div></div></a></div><div class="card"> <a href="/posts/convert-event-based-listeners-to-flux/"><div class="card-body"> <em class="small" data-ts="1573920000" data-df="ll" > Nov 16, 2019 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>⛓ Convert event-based API to Flux</h3><div class="text-muted small"><p> When working with reactive streams in Java, you may encounter a situation when there is an event-based API that must somehow return data as a stream. In my case for Reactive Streams, I use Reactor...</p></div></div></a></div><div class="card"> <a href="/posts/synology-configuring-domain-part-3/"><div class="card-body"> <em class="small" data-ts="1623265999" data-df="ll" > Jun 9, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>🔨Configuring Synology NAS to use its own domain name. Part 3</h3><div class="text-muted small"><p> In my previous two posts “Configuring Synology NAS to use own domain name. Part 1” and “Configuring Synology NAS to use its own domain name. Part 2” I described configuring DSM to update Dynamic DN...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/synology-configuring-domain-part-2/" class="btn btn-outline-primary" prompt="Older"><p>🕸 Configuring Synology NAS to use its own domain name. Part 2</p></a> <a href="/posts/the-first-steps-with-ubiquity/" class="btn btn-outline-primary" prompt="Newer"><p>🐾The First Steps With Ubiquity</p></a></div><script type="text/javascript"> $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "fisenkodv/home-page", "data-repo-id": "MDEwOlJlcG9zaXRvcnkxNTU5ODU1MTU=", "data-category": "Comments", "data-category-id": "DIC_kwDOCUwma84CPNK2", "data-mapping": "posts", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "bottom", "data-lang": "en", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementById("tail-wrapper").appendChild(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/fisenkodv">Dmitry Fisenko</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/synology/">synology</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/spring/">spring</a> <a class="post-tag" href="/tags/arduino/">arduino</a> <a class="post-tag" href="/tags/flux/">flux</a> <a class="post-tag" href="/tags/iot/">iot</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/mariadb/">mariadb</a> <a class="post-tag" href="/tags/ubiquity/">ubiquity</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-R6010500SQ"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-R6010500SQ'); }); </script>
